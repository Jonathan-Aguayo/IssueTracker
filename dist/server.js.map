{"version":3,"sources":["../server/server.js"],"names":["require","config","MongoClient","db","SourceMapSupport","install","client","useNewUrlParser","useUnifiedTopology","connect","then","connection","app","listen","console","log","catch","error","use","express","static","bodyParser","json","urlencoded","extended","name","keys","passport","initialize","session","get","req","res","collection","findOne","mongoDB","ObjectID","params","issueID","record","issue","send","filter","query","status","effortFrom","effortTo","effort","$gte","parseInt","$lte","find","toArray","metadata","total_count","issues","length","_metadata","records","message","post","newIssue","body","created","Date","Issue","validateIssue","insertOne","err","delete","deleteOne","put","_id","update","convertIssue","limit","next","updatedIssue","authenticate","scope","logout","redirect","user","JSON","stringify","successRedirect","failureRedirect","sendFile","path","resolve"],"mappings":"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","file":"server.js","sourcesContent":["import express from 'express';\nimport bodyParser from 'body-parser';\nimport Issue from './issues.js';\nimport mongoDB, { ObjectID } from 'mongodb';\nimport SourceMapSupport from 'source-map-support';\nimport passport from 'passport';\nimport cookieSession from 'cookie-session'\nimport path from 'path';\nimport 'babel-polyfill';\nrequire('dotenv').config();\nrequire('../passport-setup')\nconst MongoClient = require('mongodb').MongoClient;\n\nlet db;\nSourceMapSupport.install();\n//INITIALIZE DB\nconst client = MongoClient('mongodb+srv://JonathanA:Aguayo1@cluster0.id5hf.mongodb.net/test',{ useNewUrlParser: true, useUnifiedTopology: true });\nclient.connect().then(connection => {\ndb = connection;\napp.listen(3000, () => {\nconsole.log('app started on port 3000')\nconsole.log('Database connected successfully');\n});\n}).catch(error => {\nconsole.log('ERROR when connecting:', error);\n});\n\nconst app = express();\n//MIDDLEWARE\n\napp.use(express.static('static'));\napp.use(bodyParser.json());\napp.use(bodyParser.urlencoded({extended:false}));\napp.use(cookieSession({\n    name:'Roomies-sesion',\n    keys:['key1','key2']\n}));\napp.use(passport.initialize());\napp.use(passport.session());\n\n\n//ROUTES\napp.get('/api/v1/issues/:issueID', (req,res) =>\n{\n    db.db('test').collection('issues').findOne({\"_id\": mongoDB.ObjectID(req.params.issueID)}).then(issue =>\n        {\n            res.json({record: issue});\n        })\n        .catch(err=>\n            {\n            res.json(400).send('Issue ID is not valid')\n            });   \n});\n\napp.get('/api/v1/issues', (req,res) =>\n{\n    const filter = {};\n    if(req.query.status) filter.status = req.query.status;\n    if (req.query.effortFrom || req.query.effortTo) filter.effort = {};\n    if (req.query.effortFrom) filter.effort.$gte = parseInt(req.query.effortFrom, 10);\n    if (req.query.effortTo) filter.effort.$lte = parseInt(req.query.effortTo, 10);\n\n    db.db('test').collection('issues').find(filter).toArray().then(issues => \n        {\n            const metadata = { total_count: issues.length };\n            res.json({_metadata: metadata, records: issues});\n        }).catch(error => {console.log(error); res.status(500).json({message: `Internal server error: ${error}`}); });\n});\napp.post('/api/v1/issues', (req,res) => \n{\n    const newIssue = req.body;\n    newIssue.created = new Date();\n    if (!newIssue.status)\n    {\n        newIssue.status = 'New';\n    }   \n    let error = Issue.validateIssue(newIssue);\n    if(error)\n    {\n        res.status(400).json({error});\n        return;\n    }\n\n    db.db('test').collection('issues').insertOne(newIssue, (err,db) => {\n        if(err)\n            res.json(400).send(err)\n        else\n            res.json(newIssue);\n    });\n\n});\napp.delete('/api/v1/issues/:issueID', (req,res) =>\n{\n    db.db('test').collection('issues').findOne({\"_id\": mongoDB.ObjectID(req.params.issueID)}).then( () =>\n        {\n            db.db('test').collection('issues').deleteOne({'_id':mongoDB.ObjectID(req.params.issueID)}).then( () => \n            {\n                res.send(200)\n            })\n        })\n        .catch(err=>\n            {\n            res.json(400).send('Issue ID is not valid')\n            });   \n});\napp.put('/api/v1/issues/:issueID', (req,res) =>\n{\n    let issueID;\n    try \n    {\n        issueID = new ObjectID(req.params.issueID);\n    } \n    catch (error)\n    {\n        res.status(422).json({ message: `Invalid issue ID format: ${error}` })\n        return;\n    }\n\n    const issue = req.body;\n    delete issue._id;\n\n    const error = Issue.validateIssue(issue);\n    if(error)\n    {\n        res.status(400).json({ message: `Invalid request ${error}` });\n        return;\n    }\n\n    db.db('test').collection('issues').update({_id: issueID}, Issue.convertIssue(issue)).then( () => \n    {\n        db.db('test').collection('issues').find( {_id: issueID }).limit(1).next().then( (updatedIssue) =>{ res.json(updatedIssue) })\n        .catch( error => res.status(500).json({message: `Internal server Error: ${error}`}));\n    });\n});\napp.get('/auth/google', passport.authenticate('google', { scope:[ 'profile','email'] }\n));\napp.get('/logout', (req,res) =>\n{\n    req.session=null;\n    req.logout();\n    res.redirect('/');\n});\napp.get('/auth/google/failure',(req,res) => {res.send('Failed to log in')});\napp.get('/login/success',(req,res) => \n{\n    console.log(req.user)\n    res.send({user:JSON.stringify(req.user)});\n});\napp.get( '/auth/google/callback',passport.authenticate( 'google', {\n        successRedirect: '/auth/google/success',\n        failureRedirect: '/auth/google/failure'\n}));\napp.get('*', (req,res) =>\n{\n    res.sendFile(path.resolve('static/index.html'));\n});\n"]}